# test_utils

[![Build Status](https://travis-ci.org/relayr/erl-test-utils.svg?branch=master)](https://travis-ci.org/relayr/erl-test-utils) [![Coverage Status](https://coveralls.io/repos/github/relayr/erl-test-utils/badge.svg?branch=master)](https://coveralls.io/github/relayr/erl-test-utils?branch=master)

## Description

Erlang application that can be imported in your project to help in development of unit and property-based tests (using [Proper](https://github.com/proper-testing/proper)).

To import `test_utils` you need to add it to your rebar.config file e.g.
```
{profiles, [
    {test, [
        {deps, [test_utils]}
    ]}
]}.
```
Next step is to include `testing.hrl` in your testing modules e.g.
```
-module(my_module_tests).

-include_lib("test_utils/include/testing.hrl").
...
```

## Unit tests helpers

#### ?LOOPER(Fun, Args, LoopTimeout, Count)
This macro is used to call function `Fun` with arity matching number of arguments in the `Args` list for `Count` times until all assertions in the function pass. There's a timeout of `LoopTimeout` milliseconds between consecutive calls of the function. If function fails for `Count` times then output from last call is returned to the test.
```
ExpectedState = #state{id = ?KEY, waiting = []},
?LOOPER(fun(Key) ->
        {ok, State} = server:get_state(Key),
        ?assertEqual(ExpectedState, State)
    end,
    [?KEY],
    50, 10
).
```

#### ?WAIT_FOR_PROCESS_STOPPED(NameOrPID)
Wait 1 second until process specified by its registered name or PID is stopped. If registered name is used this macro waits until process name is unregistered.
```
?WAIT_FOR_PROCESS_STOPPED(test_server).
```

In case process isn't stopped the following error is returned in the test:
```
  1) server_tests:process_stopped_test/0
     Failure/Error: unknown assert: "Process <0.341.0> wasn't stopped!"
```

#### ?assertContains(Elem, List)
Assert that element `Elem` exists in list of elements `List`.

#### ?assertContainsAll(Elems, List)
Assert that all of elements in list `Elems` exist in list of elements `List`.

#### ?assertNotContains(Elem, List)
Assert that element `Elem` doesn't exist in list of elements `List`.

#### ?assertJson(Expected, Actual)
Assert that JSON objects are equal. Both of them can be either encoded as a string or decoded to format compatible with [jsx](https://github.com/talentdeficit/jsx).

## Property based tests generators

There's a set of helpful generators defined in `prop_testing.hrl` that can be used in your property based tests.

#### ?EQC_STRING_GEN
Generate random string with printable ASCII characters (ASCII codes 32 - 126)
```
"s"
"_"
"n"
"P"
...
"#1[<v8+.O9MQw"
"N<E?s=658Vt>@$&zV@\"-jY@#X7xtS-8NRR>@lvZWl"
"w1Sf <LQ\\2y_**U.:\")SYhuj4d"
"`\"al/s!muWWZ{L0`mBaX_y[C(j{~"
```

#### ?EQC_ATOM_GEN
Generate random atom with printable ASCII characters (ASCII codes 32 - 126)

```
'}'
'\\'
w
'4'
...
'C&XAUV[a2pZ"y{`7?'
'FBnuB H3Xr`(d3Jq/FQl3{dXyIxS]515n'
'@<$@Fu*kyPaI].gXL1P9}vmUTDL"hw'
')03jvN"OD8OEaWnoV!/v`5\'jZ/g~6i`AKt/a'
```
#### ?EQC_BYTE_GEN
Generate random unsigned byte value (values 0..255)
```
141
99
169
180
...
242
16
158
150
```

#### ?EQC_USHORT_GEN
Generate random unsigned short value (values 0..65535)

```
17211
20042
23461
40286
...
8457
37070
28076
31370
```
#### ?EQC_ULONG_GEN
Generate random unsigned long value (values 0..18446744073709551615)
```
0
0
3
2
...
75
68
25
13
```
#### ?EQC_BIN_GEN(MaxSize)
Generate random binary of size `0..MaxSize`
```
<<94,30,5,155>>
<<58,23>>
<<67,128,216,104,20,73,91>>
<<77,189,139,35>>
...
<<94,200,83,119,36,130>>
<<230,124,131,78,0,145,114,34,222,196>>
<<254,116,230,135,197,27>>
```
#### ?EQC_UNIQUE_LIST_GEN(Gen)
Generate list of values generated by `Gen` generator that contain unique values

```
[]
[1]
[1,0]
[5]
[4,1]
...
[4,5,1,3,0,2]
[5,2,4,1]
[4,0,3,1,5,2]
[2,0,5,1,4,3]
```
#### ?EQC_SORTED_UNIQUE_LIST_GEN(Gen)
Generate list of values generated by `Gen` generator that contain unique and sorted values
```
[5]
[]
[2,5]
[4,5]
[0,3]
...
[1,2,3,4,5]
[0,1,2,3,5]
[0,1,2,3,4,5]
[0,1,2,3,4,5]
```